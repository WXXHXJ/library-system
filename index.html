<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI å›¾ä¹¦é¦†ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body { background-color: #f5f7fa; margin: 0; padding: 0; font-family: "Helvetica Neue",Helvetica,"PingFang SC", "Microsoft YaHei"; }
        .container { max-width: 1200px; margin: 30px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .login-box { width: 400px; margin: 80px auto; padding: 40px; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .search-bar { margin-bottom: 20px; display: flex; gap: 10px; }
        .status-tag { font-weight: bold; }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="!isLoggedIn" class="login-box">
            <h2 style="text-align: center; color: #409EFF;">{{ isRegisterMode ? 'ç”¨æˆ·æ³¨å†Œ' : 'ç³»ç»Ÿç™»å½•' }}</h2>
            
            <el-form label-width="0">
                <el-form-item>
                    <el-input v-model="authForm.username" placeholder="ç”¨æˆ·å" prefix-icon="el-icon-user"></el-input>
                </el-form-item>
                <el-form-item>
                    <el-input v-model="authForm.password" type="password" placeholder="å¯†ç " prefix-icon="el-icon-lock"></el-input>
                </el-form-item>
                
                <div v-if="!isRegisterMode">
                    <el-button type="primary" @click="handleLogin" style="width: 100%;" :loading="loading">ç™» å½•</el-button>
                    <div style="text-align: right; margin-top: 10px;">
                        <el-link type="primary" @click="isRegisterMode = true">æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ</el-link>
                    </div>
                </div>

                <div v-else>
                    <el-button type="success" @click="handleRegister" style="width: 100%;" :loading="loading">æ³¨ å†Œ</el-button>
                    <div style="text-align: right; margin-top: 10px;">
                        <el-link type="info" @click="isRegisterMode = false">å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•</el-link>
                    </div>
                </div>
            </el-form>
        </div>

        <div v-else class="container">
            <div class="header">
                <div>
                    <h2 style="margin:0">ğŸ›ï¸ æ™ºæ…§å›¾ä¹¦é¦†ç®¡ç†ç³»ç»Ÿ</h2>
                    <span style="color: #666; font-size: 14px; margin-top: 5px; display:block;">
                        å½“å‰ç”¨æˆ·: <el-tag size="small">{{ currentUser.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·' }}</el-tag> {{ currentUser.username }}
                    </span>
                </div>
                <el-button type="danger" plain size="small" @click="logout">é€€å‡ºç™»å½•</el-button>
            </div>

            <el-tabs v-model="activeTab" @tab-click="handleTabClick">
                
                <el-tab-pane label="ğŸ“š å›¾ä¹¦å¤§å…" name="books">
                    <div class="search-bar">
                        <el-input v-model="searchKeyword" placeholder="æœç´¢ä¹¦åæˆ–ä½œè€…..." clearable @clear="loadBooks" style="width: 300px;"></el-input>
                        <el-button type="primary" @click="loadBooks">æŸ¥è¯¢</el-button>
                        
                        <el-button v-if="currentUser.role === 'admin'" type="success" @click="showAddDialog = true" style="margin-left: auto;">+ æ–°ä¹¦å…¥åº“</el-button>
                    </div>

                    <el-table :data="books" border stripe>
                        <el-table-column prop="title" label="ä¹¦å" min-width="150"></el-table-column>
                        <el-table-column prop="author" label="ä½œè€…" width="120"></el-table-column>
                        <el-table-column prop="publisher" label="å‡ºç‰ˆç¤¾" width="150"></el-table-column>
                        <el-table-column prop="location" label="ä½ç½®" width="100"></el-table-column>
                        <el-table-column prop="isbn" label="ISBN" width="120"></el-table-column>
                        
                        <el-table-column label="çŠ¶æ€" width="100" align="center">
                            <template #default="scope">
                                <el-tag v-if="scope.row.stock < 1 && scope.row.stock > -1" type="danger">ç¼ºè´§</el-tag>
                                <el-tag v-else-if="scope.row.stock < 0" type="info">å·²ä¸‹æ¶</el-tag> <el-tag v-else type="success">åº“å­˜ {{ scope.row.stock }}</el-tag>
                            </template>
                        </el-table-column>

                        <el-table-column label="æ“ä½œ" width="180" fixed="right">
                            <template #default="scope">
                                <el-button type="primary" size="small" 
                                    :disabled="scope.row.stock < 1"
                                    @click="borrowBook(scope.row.id)">
                                    å€Ÿé˜…
                                </el-button>

                                <el-button v-if="currentUser.role === 'admin'" type="warning" size="small" 
                                    @click="offlineBook(scope.row.id)">
                                    ä¸‹æ¶
                                </el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </el-tab-pane>

                <el-tab-pane label="ğŸ“ æˆ‘çš„å€Ÿé˜…" name="records">
                    <el-table :data="myRecords" border>
                        <el-table-column prop="bookTitle" label="å€Ÿé˜…ä¹¦å"></el-table-column>
                        <el-table-column prop="borrowDate" label="å€Ÿå‡ºæ—¶é—´"></el-table-column>
                        <el-table-column prop="returnDate" label="å½’è¿˜æ—¶é—´">
                            <template #default="scope">{{ scope.row.returnDate || '-' }}</template>
                        </el-table-column>
                        <el-table-column prop="status" label="çŠ¶æ€" width="100">
                            <template #default="scope">
                                <el-tag :type="scope.row.status === 'å€Ÿé˜…ä¸­' ? 'warning' : 'success'">{{ scope.row.status }}</el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="æ“ä½œ" width="100">
                            <template #default="scope">
                                <el-button v-if="scope.row.status === 'å€Ÿé˜…ä¸­'" type="success" size="small" @click="returnBook(scope.row.id)">å½’è¿˜</el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </el-tab-pane>
            </el-tabs>
        </div>

        <el-dialog v-model="showAddDialog" title="æ–°ä¹¦å…¥åº“" width="500px">
            <el-form :model="newBookForm" label-width="80px">
                <el-form-item label="ä¹¦å"><el-input v-model="newBookForm.title"></el-input></el-form-item>
                <el-form-item label="ä½œè€…"><el-input v-model="newBookForm.author"></el-input></el-form-item>
                <el-form-item label="å‡ºç‰ˆç¤¾"><el-input v-model="newBookForm.publisher" placeholder="ä¾‹: æ¸…åå¤§å­¦å‡ºç‰ˆç¤¾"></el-input></el-form-item>
                <el-form-item label="é¦†è—ä½ç½®"><el-input v-model="newBookForm.location" placeholder="ä¾‹: AåŒº-3æ’"></el-input></el-form-item>
                <el-form-item label="ISBN"><el-input v-model="newBookForm.isbn"></el-input></el-form-item>
                <el-form-item label="åº“å­˜"><el-input-number v-model="newBookForm.stock" :min="1"></el-input-number></el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showAddDialog = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="addBook">ç¡®è®¤å…¥åº“</el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, reactive } = Vue;
        const app = createApp({
            setup() {
                // çŠ¶æ€å®šä¹‰
                const isLoggedIn = ref(false);
                const isRegisterMode = ref(false); // æ§åˆ¶ç™»å½•/æ³¨å†Œåˆ‡æ¢
                const loading = ref(false);
                const currentUser = ref({});
                const authForm = reactive({ username: '', password: '' });
                
                const books = ref([]);
                const myRecords = ref([]);
                const activeTab = ref('books');
                const searchKeyword = ref('');
                
                // æ–°ä¹¦è¡¨å•
                const showAddDialog = ref(false);
                const newBookForm = reactive({ title: '', author: '', isbn: '', publisher: '', location: '', stock: 5 });

                const API_URL = 'http://127.0.0.1:5000/api';

                // 1. ç™»å½•
                const handleLogin = async () => {
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API_URL}/login`, authForm);
                        if (res.data.code === 200) {
                            currentUser.value = res.data.data;
                            isLoggedIn.value = true;
                            ElementPlus.ElMessage.success('ç™»å½•æˆåŠŸ');
                            loadBooks();
                        } else {
                            ElementPlus.ElMessage.error(res.data.msg);
                        }
                    } catch (e) { ElementPlus.ElMessage.error('è¿æ¥æœåŠ¡å™¨å¤±è´¥'); }
                    loading.value = false;
                };

                // 2. æ³¨å†Œ (æ–°å¢)
                const handleRegister = async () => {
                    loading.value = true;
                    try {
                        const res = await axios.post(`${API_URL}/register`, authForm);
                        if (res.data.code === 200) {
                            ElementPlus.ElMessage.success('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç›´æ¥ç™»å½•');
                            isRegisterMode.value = false; // åˆ‡æ¢å›ç™»å½•æ€
                        } else {
                            ElementPlus.ElMessage.error(res.data.msg);
                        }
                    } catch (e) { ElementPlus.ElMessage.error('æ³¨å†Œè¯·æ±‚å¤±è´¥'); }
                    loading.value = false;
                };

                // åŠ è½½å›¾ä¹¦
                const loadBooks = async () => {
                    const res = await axios.get(`${API_URL}/books`, { params: { keyword: searchKeyword.value } });
                    books.value = res.data.data;
                };

                // åŠ è½½å€Ÿé˜…è®°å½•
                const loadRecords = async () => {
                    if (!currentUser.value.userId) return;
                    const res = await axios.get(`${API_URL}/records`, { params: { userId: currentUser.value.userId } });
                    myRecords.value = res.data.data;
                };

                // å€Ÿä¹¦
                const borrowBook = async (bookId) => {
                    try {
                        const res = await axios.post(`${API_URL}/borrow`, { userId: currentUser.value.userId, bookId });
                        if (res.data.code === 200) {
                            ElementPlus.ElMessage.success('å€Ÿé˜…æˆåŠŸ');
                            loadBooks();
                        } else { ElementPlus.ElMessage.warning(res.data.msg); }
                    } catch(e) { ElementPlus.ElMessage.error('è¯·æ±‚å¤±è´¥'); }
                };

                // å½’è¿˜
                const returnBook = async (recordId) => {
                    try {
                        const res = await axios.post(`${API_URL}/return`, { recordId });
                        if (res.data.code === 200) {
                            ElementPlus.ElMessage.success('å½’è¿˜æˆåŠŸ');
                            loadRecords();
                            if(activeTab.value === 'books') loadBooks();
                        } else { ElementPlus.ElMessage.warning(res.data.msg); }
                    } catch(e) { ElementPlus.ElMessage.error('è¯·æ±‚å¤±è´¥'); }
                };

                // ç®¡ç†å‘˜ï¼šå…¥åº“ (æ–°å¢å­—æ®µ)
                const addBook = async () => {
                    try {
                        const res = await axios.post(`${API_URL}/books`, newBookForm);
                        if (res.data.code === 200) {
                            ElementPlus.ElMessage.success('å…¥åº“æˆåŠŸ');
                            showAddDialog.value = false;
                            loadBooks();
                            // é‡ç½®è¡¨å•
                            Object.assign(newBookForm, { title: '', author: '', isbn: '', publisher: '', location: '', stock: 5 });
                        } else { ElementPlus.ElMessage.warning(res.data.msg); }
                    } catch(e) { ElementPlus.ElMessage.error('å…¥åº“å¤±è´¥'); }
                };

                // ç®¡ç†å‘˜ï¼šä¸‹æ¶ (æ–°å¢åŠŸèƒ½)
                const offlineBook = async (bookId) => {
                    try {
                        await ElementPlus.ElMessageBox.confirm('ç¡®å®šè¦ä¸‹æ¶è¿™æœ¬å›¾ä¹¦å—ï¼Ÿä¸‹æ¶åå°†æ— æ³•å€Ÿé˜…ã€‚', 'æç¤º', { type: 'warning' });
                        const res = await axios.put(`${API_URL}/books/${bookId}`, { status: 0 }); // è°ƒç”¨ PUT æ¥å£
                        if (res.data.code === 200) {
                            ElementPlus.ElMessage.success('å›¾ä¹¦å·²ä¸‹æ¶');
                            loadBooks(); // åˆ·æ–°åˆ—è¡¨ï¼Œè¯¥ä¹¦åº”æ¶ˆå¤±æˆ–å˜ç°
                        }
                    } catch(e) { 
                        if(e !== 'cancel') ElementPlus.ElMessage.error('æ“ä½œå¤±è´¥'); 
                    }
                };

                const handleTabClick = (tab) => {
                    if (tab.paneName === 'records') loadRecords();
                    if (tab.paneName === 'books') loadBooks();
                };

                const logout = () => { 
                    isLoggedIn.value = false; 
                    Object.assign(authForm, { username: '', password: '' });
                };

                return { 
                    isLoggedIn, isRegisterMode, loading, authForm, currentUser, 
                    handleLogin, handleRegister, logout,
                    books, searchKeyword, loadBooks, borrowBook, offlineBook,
                    activeTab, myRecords, handleTabClick, returnBook,
                    showAddDialog, newBookForm, addBook
                };
            }
        });
        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>